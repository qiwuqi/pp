name: ⏰ 自动抓取代理列表

on:
  schedule:
    - cron: '0 */4 * * *'  # 每 4 小时执行一次
  workflow_dispatch:

jobs:
  fetch-proxies:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ 拉取仓库代码
        uses: actions/checkout@v3

      - name: 📦 安装依赖
        run: npm install

      - name: 🕵️‍♂️ 抓取代理并生成文件（带重试机制）
        run: |
          n=0
          until [ $n -ge 3 ]; do
            echo "第 $((n+1)) 次尝试..."
            node proxy-fetcher/fetch-proxies.mjs && break
            echo "失败，3 秒后重试..."
            n=$((n+1))
            sleep 3
          done
        timeout-minutes: 3  # 最长执行时间 3 分钟

      - name: 📤 推送更新
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proxy-list.txt
          git commit -m "🤖 自动更新代理列表 $(date '+%F %T')" || echo "无变更"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
